<template>
    <div>
        <div class='mt-4'>
            <label class='label' for='title'>任務標題</label>
            <v-text-field v-model='data.title' :rules='currentRules.title' :counter='hintMsgs.taskTitle.counter'
                :hint='hintMsgs.taskTitle.hint' placeholder="請輸入任務標題" id="title" @keypress.enter.prevent />
        </div>
        <div class='mt-4'>
            <label class='label' for='category'>服務類別</label>
            <v-select v-model='data.category' :rules='currentRules.category' :items='taskCategories' item-title='name'
                item-value='name' placeholder="請選擇服務類別" id="category" clearable>
            </v-select>
        </div>
        <div class='mt-4'>
            <label class='label' for='description'>任務說明</label>
            <v-textarea v-model='data.description' :rules='currentRules.description'
                :counter='hintMsgs.taskDescription.counter' :hint='hintMsgs.taskDescription.hint' placeholder="請輸入任務說明"
                id="description" />
        </div>
        <div class='mt-4 md:sp-w-1/2 lg:sp-w-1/3'>
            <label class='label' for='salary'>任務薪水</label>
            <v-text-field v-model='data.salary' :rules='currentRules.salary' type='number' prefix=$ suffix=超人幣 id="salary"
                @keypress.enter.prevent />
        </div>
        <div class='mt-4'>
            <label class='label'>曝光方案</label>
            <div class='d-md-flex'>
                <v-radio-group v-model='data.exposurePlan' v-for='(item, index) in exposurePlans' :key='index'
                    :rules='currentRules.exposurePlan'>
                    <v-radio :label='`${item.title} ${item.price}點`' :value='item.title'></v-radio>
                </v-radio-group>
            </div>
        </div>
    </div>
</template>
<script setup>

const data = inject('basic')
const currentRules = inject('currentRules')
const hintMsgs = inject('hintMsgs')


import { storeToRefs } from "pinia";
import { storeFullOverlay } from "@/stores/storeFullOverlay";
import { storePostTask } from "@/stores/storePostTask";
import { getCategories, getExposurePlan } from '@/services/apis/general';
import { getAccountPoints } from '@/services/apis/point';
const _storeFullOverlay = storeFullOverlay();
const _storePostTask = storePostTask();
const { excuteAsyncFunc, promiseErrorHanlder } = useSpUtility()
const { logInfo, logError } = useLog()
const { openModal, closeModal } = storePostTask();
const { userCoin, btnDisabled } = storeToRefs(_storePostTask);
let descriptionTemplateList = []
const exposurePlans = ref([])
const taskCategories = ref([])
const _work = '刊登任務'


const init = () => {
    //console.time()
    _storeFullOverlay.open()
    btnDisabled.value = true
    const promises = [
        excuteAsyncFunc(_work, getExposurePlan, null, (response) => exposurePlans.value = response.data),
        excuteAsyncFunc(_work, getCategories, null, (response) => {
            taskCategories.value = response.data
            descriptionTemplateList = response.data.map(item => item.template)
        }),
        excuteAsyncFunc(_work, getAccountPoints, null, (response) => {
            userCoin.value = response.data
            //增加任務薪水檢查規則
            const index = currentRules.value.salary.findIndex((item) => item == 'checkUserCoin')
            if (index >= 0) {
                currentRules.value.salary[index] = (v) => v <= userCoin.value.superCoin || `不可超過目前帳戶儲值餘額 ${userCoin.value.superCoin} 點超人幣`
            }
            // console.log(userCoin.value)
        })
    ];
    Promise.allSettled(promises).then(results => {
        if (!process.client) return;
        logInfo(_work, 'init.results', results)
        const _message = promiseErrorHanlder(results)
        //logInfo(_work, 'results.message', _message)
        if (_message && _message.length > 0) {
            openModal({
                message: _message
            })
        } else {
            btnDisabled.value = false
        }
        //console.timeEnd()
    }).finally(() => {
        _storeFullOverlay.close()
    });
}
init();



// - 選擇服務類別帶出任務說明 -
watch(() => data.category, (nV, oV) => {
    // 動作是清空就離開
    if (!nV) return;
    // 如果任務說明是空的，就直接帶入樣板
    const newObj = taskCategories.value?.find(item => item.name === nV)
    if (newObj && newObj.template && !data.description) {
        data.description = newObj.template
        return;
    }
    // 只要任務說明是樣板，就可以被替換
    const index = descriptionTemplateList.findIndex(item => item === data.description)
    if (index >= 0) {
        data.description = newObj.template
        return;
    }
})

</script>
<style lang="postcss" scoped>
@import url("@/assets/css/tailwind.css");

.label {
    @apply sp-text-gray-placeholder sp-font-bold sp-mb-2 sp-inline-block
}
</style>